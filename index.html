<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Icon Sandbox</title>

  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    pre { white-space: pre-wrap; word-break: break-word; background:#f6f8fa; padding:12px; border-radius:10px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:10px 0; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <div class="row">
    <div>
      <div><b>User:</b> <span id="user">—</span></div>
      <div><b>Patient:</b> <span id="patient">—</span></div>
      <div><b>FHIR:</b> <span id="fhir">—</span></div>
    </div>
    <button id="btnRefresh">Refresh</button>
    <button id="btnReload">Reload</button>
  </div>

  <hr/>

  <div class="card">
    <div><b>Vendor:</b></div>
    <div class="row">
      <div>Epic</div>
      <label class="row" style="gap:6px;">
        <input type="checkbox" id="useImages" checked />
        <span>Use images (simulated)</span>
      </label>
    </div>
  </div>

  <div id="items"></div>

  <div class="card">
    <div><b>Log:</b></div>
    <pre id="log"></pre>
  </div>

<script>
  const logEl = document.getElementById("log");
  const log = (msg) => {
    const ts = new Date().toLocaleTimeString();
    logEl.textContent += `[${ts}] ${msg}\n`;
  };

  const userEl = document.getElementById("user");
  const patientEl = document.getElementById("patient");
  const fhirEl = document.getElementById("fhir");
  const itemsEl = document.getElementById("items");

  // IMPORTANT: must match launch.html + callback.html
  const storage = window.localStorage;

  // Your existing icon list (keep/expand as you want)
  const ICONS = [
    { key:"line_picc", label:"PICC", resource:"Device" },
    { key:"gu_foley", label:"Foley", resource:"Device" },
    { key:"resp_hfnc", label:"HFNC", resource:"Device" },
    { key:"drain_jp", label:"JP drain", resource:"Device" },
    { key:"drain_chest_tube", label:"Chest tube", resource:"Device" },
    { key:"gi_peg", label:"PEG", resource:"Device" },
    { key:"safety_isolation", label:"Isolation", resource:"Flag" },
    { key:"monitor_telemetry", label:"Telemetry", resource:"Observation" },
    { key:"room_whiteboard", label:"Whiteboard", resource:"UI" }
  ];

  function render(authenticated) {
    itemsEl.innerHTML = "";
    for (const it of ICONS) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div><b>${it.key}</b></div>
        <div>${it.label}</div>
        <div class="muted">${it.resource}</div>
        <div class="muted">${authenticated ? "Authenticated ✅" : "Not authenticated (launch from Epic)"}</div>
      `;
      itemsEl.appendChild(div);
    }
  }

  async function init() {
    log("Starting…");

    // default UI before auth
    render(false);

    try {
      // If we have a saved SMART session, this will succeed
      const client = await FHIR.oauth2.ready({ storage });

      fhirEl.textContent = client.state.serverUrl || "—";
      patientEl.textContent = client.patient?.id || "—";
      userEl.textContent = client.user?.id || "—";

      log("SMART session found ✅");
      render(true);

    } catch (e) {
      log("No SMART session yet (open from Epic launch).");
      // remain unauthenticated
      render(false);
    }

    // heartbeat so you see it running
    setInterval(() => log("heartbeat"), 8000);
  }

  document.getElementById("btnReload").addEventListener("click", () => location.reload());
  document.getElementById("btnRefresh").addEventListener("click", async () => {
    log("Manual refresh…");
    try {
      const client = await FHIR.oauth2.ready({ storage });
      log("Still authenticated ✅");
      render(true);
    } catch {
      log("Not authenticated.");
      render(false);
    }
  });

  init();
</script>
</body>
</html>
